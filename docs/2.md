**网络是怎样连接的》笔记**

<div>

![](%E3%80%8A%E7%BD%91%E7%BB%9C%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%9E%E6%8E%A5%E7%9A%84%E3%80%8B%E7%AC%94%E8%AE%B0.resources/0D46B906-2AAC-4889-85C4-39A21C17506F.png)

</div>

<div>

![](%E3%80%8A%E7%BD%91%E7%BB%9C%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%9E%E6%8E%A5%E7%9A%84%E3%80%8B%E7%AC%94%E8%AE%B0.resources/61346478-DC8F-4364-A5FC-DD99FB9AE330.png)

</div>
 

<div style="font-weight: bold;">

[Web浏览器\--浏览器生成消息]

</div>

<div>

浏览器、web服务器、网址（URL）、HTTP、HTML、协议、URI、请求消息、解析器、Socket库、DNS服务器、域名

</div>
 

<div style="color: rgb(79, 143, 0);">

[生成HTTP请求消息]

</div>

<div>

输入网址 -\> 解析URL -\> 确定web服务器和文件名 -\> 生成HTTP请求消息

</div>

<div>

请求消息：请求行+消息头+消息体

</div>

<div>

响应消息：状态行+消息头+消息体

</div>
 

<div style="color: rgb(79, 143, 0);">

[向DNS服务器查询web服务器的IP地址] 

</div>

<div>

1、IP地址是一串32比特的数字，8比特一组分为4组。分别用十进制表示再用圆点隔开。

</div>
 

<div>

2、子网掩码格式与IP类似。左边一半都是1，右边一半都是0.子网掩码为1的部分表示网络号，子网掩码为0的部分表示主机号。主机号全0表示整个子网，全1表示向子网所有设备发送包，即广播。

</div>
 

<div>

3、通过DNS查询IP地址的操作称为域名解析，计算机上的这一解析器包含在操作系统的Socket库中。Socket
库是用于调用网络功能的程序组件集合。

</div>
 

<div style="color: rgb(79, 143, 0);">

[DNS服务器工作] 

</div>

<div>

1、DNS 服务器会从域名与 IP 地址的对照表中查找相应的记录，并返回IP地址。

</div>
 

<div>

2、DNS
服务器中的所有信息都是按照域名以分层次的结构来保存的，一个域的信息是作为一个整体存放在
DNS 服务器中的，可以通过创建下级的域来分配给不同的服务器。

</div>
 

<div style="color: rgb(79, 143, 0);">

[委托协议栈发送消息] 

</div>

<div>

向操作系统内部的协议栈发出委托时，需要按照指定的顺序来调 用 Socket
库中的程序组件。

</div>

-   <div>

    创建套接字(创建套接字阶段) 

    </div>

-   <div>

    将管道连接到服务器端的套接字上(连接阶段) 

    </div>

-   <div>

    收发数据(通信阶段) 

    </div>

-   <div>

    断开管道并删除套接字(断开阶段)

    </div>
 
 
 

<div  >

[协议栈、网卡---用电信号传输TCP/IP数据]

</div>

<div>

TCP/IP、套接字、协议栈、IP地址、端口号、包、头部、网卡、网卡驱动、MAC地址、以太网控制器、ICMP、UDP

</div>
 

<div style="color: rgb(79, 143, 0);">

[创建套接字] 

</div>

<div>

1、协议栈的内部结构

</div>

-   <div>

    应用程序（浏览器、电子邮件客户端、web服务器、电子邮件服务器）
    ---\> Socket库（包括解析器）

    </div>

-   <div>

    操作系统内部（包括协议栈）。协议栈上半部分（TCP/UDP），接受应用程序的委托执行收发数据的操作，像浏览器、邮件等一般的应用程序都是使用TCP 收发数据的，而像 DNS 查询 等收发较短的控制数据的时候则使用UDP；协议栈下半部分（IP），IP 中还包括 ICMPA 协议和 ARPB 协议。 ICMP用于告知网络包传送过程中产生的错误以及各种控制消息，ARP 用 于根据 IP地址查询相应的以太网 MAC 地址

    </div>

-   <div>

    网卡驱动程序。负责控制网卡硬件

    </div>

-   <div>

    网卡。负责完成实际的收发操作，也就是对网线中的信号执行发送和接收的操作。

    </div>
 

<div>

2、套接字的实体就是通信控制信息

</div>

<div>

    在 Windows 中可以用 netstat
命令显示套接字内容，协议栈是根据套接字中记录的控制信息来工作的。

</div>
 

<div>

3、调用 socket 时的操作

</div>

-   <div>

    应用程序调用 socket 申请创建套接字，协议栈根据应用程序的申请执行创建套接字的操作

    </div>

-   <div>

    创建套接字时，首先分配一个套接字所需的内存空间，然后向其中写入初始状态。

    </div>
 

<div style="color: rgb(79, 143, 0);">

[连接服务器] 

</div>

<div>

创建套接字之后，应用程序(浏览器)就会调用 connect，随后协议栈会将本地的套接字与服务器的套接字进行连接

</div>

<div>

1、负责保存控制信息的头部

</div>

<div>

控制信息可以分为两类，第一类是客户端和服务器相互联络时交换的控制信息；另一类，是保存在套接字中，用来控制协议栈操作的信息

</div>
 

<div>

2、连接操作的实际过程

</div>
 

<div style="color: rgb(79, 143, 0);">

[收发数据] 

</div>

<div>

当控制流程从 connect 回到应用程序之后，接下来就进入数据收发阶段了

</div>

<div>

1、将 HTTP 请求消息交给协议栈

</div>

-   <div>

    数据收发操作是从应用程序调用 write 将要发送的数据交给协议栈开始的，协议栈收到数据后将数据存放在内部的发送缓冲区中，在数据积累到一定量（MTU、MSS）时再发送出去。

    </div>

-   <div>

    像浏览器这种会话型的应用程序在向服务器发送数据时，等待填满缓冲区导致延迟会产生很大影响，因此一般会使用直接发送的选项。

    </div>
 

<div>

2、对较大的数据进行拆分

</div>
 

<div>

3、使用 ACK 号确认网络包已收到

</div>

<div>

    通过"序号"和"ACK 号"可以确认接收方是否收到了网络包。

</div>
 

<div>

4、根据网络包平均往返时间调整 ACK 号等待时间

</div>

<div>

TCP 采用了动态调整等待时间的方法，这个等待时间是根据 ACK号返回所需的时间来判断的。具体来说，TCP 会在发送数据 的过程中持续测量ACK 号的返回时间，如果 ACK 号返回变慢，则相应延长等待时间;相对地，如果ACK 号马上就能返回，则相应缩短等待时间 。

</div>
 

<div>

5、使用窗口有效管理 ACK 号

</div>
 

<div >

6、[ACK 与窗口的合并]

</div>
 

<div>

7、接收 HTTP 响应消息

</div>

<div>

    首先，浏览器在委托协议栈发送请求消息之后，会调用 read程序来获取响应消息。然后控制流程会通过 read 转移到协议栈，协议栈会执行接下来的操作。和发送数据一样，接收数据也需要将数据暂存到接收缓冲区中。首先，协议栈尝试从接收缓冲区中取出数据并传递给应用程序，但这个时候请求消息刚刚发送出去，响应消息可能还没返回。响应消息的返回还需要等待一段时间，因此这时接收缓冲区中并没有数据，那么接收数据的操作也就无法继续。这时，协议栈会将应用程序的委托，也就是从接收缓冲区中取出数据并传递给应用程序的工作暂时挂起
，等服务器返回的响应消息到达之后再继续执行接收操作。

</div>

<div>

    首先，协议栈会检查收到的数据块和 TCP头部的内容，判断是否有数据丢失，如果没有问题则返回 ACK号。然后协议栈将数据块暂存到接收缓冲区中，并将数据块按顺序连接起来还原出原始的数据，最后将数据交给应用程序。具体来说，协议栈会将接收到的数据复制到应用程序指定的内存地址中，然后将控制流程交回应用程序。将数据交给应用程序之后，协议栈还需要找到合适的时机向发送方发送窗口更新
B。

</div>
 

<div style="color: rgb(79, 143, 0);">

[从服务器断开并删除套接字] 

</div>

<div>

1、数据发送完毕后断开连接

</div>

<div>

  
 数据发送完毕的一方会发起断开过程，但不同的应用程序会选择不同的断开时机

</div>

<div>

    以服务器一方发起断开过程为例来进行讲解。首先，服务器一方的应用程序会调用 Socket 库的 close 程序。然后，服务器的协议栈会生成包含断开信息的TCP 头部，具体来说就是将控制位中的 FIN 比特设为 1。接下来，协议栈会委托IP 模块向客户端发送数据。同时，服务器的套接字中也会记录下断开操作的相关信息。接下来轮到客户端了。当收到服务器发来的FIN 为 1 的 TCP 头部时，客户端的协议栈会将自己的套接字标记为进入断开操作状态。然后，为了告知服务器已收到FIN 为 1 的包，客户端会向服务器返回一个 ACK号。这些操作完成后，协议栈就可以等待应用程序来取数据了。过了一会儿，应用程序就会调用read 来读取数据，这时，协议栈会告知应用程序(浏览器)来自服务器的数据已经全部收到了。因此，客户端应用程序会调用 close来结束数据收发操作，这时客 户端的协议栈也会和服务器一样，生成一个 FIN比特为 1 的 TCP 包，然后委托 IP模块发送给服务器。一段时间之后，服务器就会返回 ACK号。到这里，客户端和服务器的通信就全部结束了。

</div>
 

<div>

2、删除套接字

</div>

<div>

  
 和服务器的通信结束之后，用来通信的套接字并不会立即被删除，而是会等待一段时间之后再被删除，为了防止误操作。

</div>
 

<div>

3、数据收发操作小结

</div>

-   <div>

    创建套接字。

    </div>

-   <div>

    客户端会向服务器发起连接（SYN -\> SYN+ACK -\> ACK）。

    </div>

-   <div>

    数据收发阶段（Web：序号+数据、ACK、窗口）。

    </div>

-   <div>

    断开操作（Web：FIN -\> ACK -\> \...FIN -\> \...ACK -\>
    套接字被删除）

    </div>
 

<div style="color: rgb(79, 143, 0);">

[IP与以太网的包收发操作] 

</div>

<div>

1、包的基本知识

</div>

<div>

![](%E3%80%8A%E7%BD%91%E7%BB%9C%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%9E%E6%8E%A5%E7%9A%84%E3%80%8B%E7%AC%94%E8%AE%B0.resources/5C3432C0-CCA0-462D-BECD-E466722DF9D2.png)
</div>

<div>

2、包收发操作概览

</div>

<div>

3、生成包含接收方 IP 地址的 IP 头部

</div>

<div>

4、生成以太网用的 MAC 头部

</div>

<div>

5、通过 ARP 查询目标路由器的 MAC 地址

</div>

<div>

6、以太网的基本知识

</div>

<div>

7、将 IP 包转换成电或光信号发送出去

</div>

<div>

8、给网络包再加 3 个控制数据

</div>

<div>

9、向集线器发送网络包

</div>

<div>

10、接收返回包

</div>

<div>

11、将服务器的响应包从 IP 传递给 TCP

</div>
 

<div style="color: rgb(79, 143, 0);">

[UDP协议的收发操作] 

</div>

<div>

1、不需要重发的数据用 UDP 发送更高效

</div>

<div>

    UDP 没有 TCP 的接收确认、窗口等机制，因此在收发数据之前也不
需要交换控制信息，也就是说不需要建立和断开连接的步骤，只要在从应
用程序获取的数据前面加上 UDP 头部，然后交给 IP 进行发送就可以了

</div>
 

<div>

2、控制用的短数据

</div>

<div>

    接收也很简单，只要根据 IP 头部中的接收方和发送方 IP 地址， 以及 UDP
头部中的接收方和发送方端口号，找到相应的套接字并将数据交
给相应的应用程序就可以了

</div>
 

<div>

3、音频和视频数据

</div>

<div>

    发送音频和视频数据的时候使用 UDP

</div>
 
 

<div>

[集线器、交换机、路由\--从网络 到网线设备] 

</div>

<div>

局域网（LAN）、双绞线、串扰、中继式集线器、MDI、MDI-X、交换式集线器、双全工、半双工、碰撞、自动协商、路由器、路由表、子网掩码、默认网关、分片、地址转换、公有地址、私有地址

</div>
 
 

<div>

[接入网、网络运营商\--通过接入网进入互联网内部] 

</div>

<div>

ADSL、FTTH、光纤、接入网、ADSL、Modern集成式路由器、ATM、信元、正交振幅调制、分离器、DSLAM、宽带接入服务器、远程接入服务器、PPP、网络运行中心（NOC）、光纤、IX（互联网交换）

</div>
 
 

<div>

[防火墙、缓存服务器---服务端的局域网中有什么玄机] 

</div>

<div>

防火墙、包过滤器、数据中心、轮询、负载均衡器、缓存服务器、代理、代理服务器、内容分发服务、重定向

</div>

<div style="color: rgb(79, 143, 0);">

[Web 服务器的部署地点] 

</div>
 

<div style="color: rgb(79, 143, 0);">

[防火墙的结构和原理] 

</div>

<div>

1、主流的包过滤方式

</div>

<div>

    包过滤、应用层网关、电路层网关等几种方式

</div>
 

<div>

2、如何设置包过滤的规则

</div>

<div>

3、通过端口号限定应用程序

</div>

<div>

4、通过控制位判断连接方向

</div>

<div>

5、从公司内网访问公开区域的规则

</div>

<div>

6、从外部无法访问公司内网

</div>
 

<div style="color: rgb(79, 143, 0);">

[通过将请求平均分配给多台服务器来平衡负载] 

</div>

<div>

使用负载均衡器分配访问

</div>
 

<div style="color: rgb(79, 143, 0);">

[利用缓存服务器分担负载] 

</div>

<div>

1、如何使用缓存服务器

</div>

<div>

    缓存服务器是一台通过代理机制对数据进行缓存的服务器

</div>

<div>

2、缓存服务器通过更新时间管理内容

</div>

<div>

3、最原始的代理------正向代理

</div>

<div>

4、正向代理的改良版------反向代理

</div>

<div>

5、透明代理

</div>
 

<div style="color: rgb(79, 143, 0);">

[内容分发服务] 

</div>

<div>

1、利用内容分发服务分担负载

</div>

<div>

2、如何找到最近的缓存服务器

</div>

<div>

3、通过重定向服务器分配访问目标

</div>

<div>

4、缓存的更新方法会影响性能

</div>
 
 

<div >

Web服务器\--请求到达web服务器，响应返回浏览器

</div>

<div>

响应消息、多任务、多线程、虚拟目录、CGL、表单、访问控制、密码、数据格式、MIME

</div>

<div>

服务器概览

</div>

<div>

服务器的接收操作

</div>

<div>

Web 服务器程序解释请求消息并作出响应

</div>

<div>

浏览器接收响应消息并显示内容

</div>
 
 

 
 
